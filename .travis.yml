before_install:
  - if test -e $HOME/miniconda/bin; then
        echo "miniconda already installed.";
    else
      if [[ "$TRAVIS_PYTHON_VERSION" == "2.7" ]]; then
        wget https://repo.continuum.io/miniconda/Miniconda2-latest-Linux-x86_64.sh -O miniconda.sh;
      else
        wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh;
      fi

      rm -rf $HOME/miniconda;
      bash miniconda.sh -b -p $HOME/miniconda;
      export PATH="$HOME/miniconda/bin:$PATH";
      hash -r;

      conda config --add channels defaults;
      conda config --add channels bioconda;
      conda config --add channels conda-forge;

      conda config --set always_yes yes --set changeps1 no;

      conda update -q conda;

      conda config --set channel_priority strict;

      conda info -a;
    fi;

    export MONOCLE_VERSION="4d37597bebd2e8f2ef89eaf11111fb0ab9e4063e";
    export TEST_ENV="monocle_2_99_3";
    if test -e $HOME/miniconda/envs/${TEST_ENV}; then
        echo "${TEST_ENV} already created.";
    else
      conda create -n ${TEST_ENV} python=$TRAVIS_PYTHON_VERSION bioconductor-monocle=2.10.0 bioconductor-delayedmatrixstats bioconductor-iranges louvain r-devtools r-doparallel r-future r-ggridges r-glmnet r-globals r-htmltools r-htmlwidgets r-listenv r-lpsolveapi r-pbapply r-plotly r-reticulate r-rgl r-spdep r-tidyr umap-learn;
      conda remove -n ${TEST_ENV} r-ddrtree bioconductor-monocle;
      $HOME/miniconda/envs/${TEST_ENV}/bin/Rscript -e 'install.packages("pbmcapply", repos="https://cran.ma.imperial.ac.uk")';
      $HOME/miniconda/envs/${TEST_ENV}/bin/Rscript -e 'devtools::install_github("cole-trapnell-lab/DDRTree", ref="simple-ppt-like", upgrade="never")';
      $HOME/miniconda/envs/${TEST_ENV}/bin/Rscript -e 'devtools::install_github("cole-trapnell-lab/L1-graph", upgrade="never")';
      $HOME/miniconda/envs/${TEST_ENV}/bin/Rscript -e 'devtools::install_github("cole-trapnell-lab/monocle-release", ref="'${MONOCLE_VERSION}'", upgrade="never")';
    fi

install:
    - export PATH="$HOME/miniconda/bin:$PATH"
    - source activate monocle_2_99_3

before_script:
    - export PATH=`pwd`:$PATH

script: $HOME/miniconda/envs/${TEST_ENV}/bin/Rscript -e 'suppressPackageStartupMessages(library(monocle)); stopifnot(packageVersion("monocle")=="2.99.3")' && ./monocle-scripts-post-install-tests.bats

cache:
  directories:
      - $HOME/miniconda
      - post_install_tests

before_cache:
    - if ! [[ $TRAVIS_TAG ]]; then rm -rf $HOME/miniconda/conda-bld; fi
    - rm -rf post_install_tests/outputs
    - rm -rf $HOME/miniconda/locks $HOME/miniconda/pkgs $HOME/miniconda/var $HOME/miniconda/conda-meta/history
